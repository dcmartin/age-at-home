###
### MINIMUM
###

homeassistant:
  # Name of the location where Home Assistant is running
  name: Fazenda da Saudade
  # Location required to calculate the time the sun rises and sets
  latitude: 37.174956
  longitude: -121.816344
  # Impacts weather/sunrise data (altitude above sea level in meters)
  elevation: 827
  # metric for Metric, imperial for Imperial
  unit_system: imperial
  # Pick yours from here: http://en.wikipedia.org/wiki/List_of_tz_database_time_zones
  time_zone: America/Los_Angeles
  # customize (optional)
  customize: !include customize.yaml

## no parameters necessary

cloud: # uses home-assistant cloud service
hassio: # use hassio supervisor
discovery: # find automatically
frontend: # build a http interface (see HTTP below)
config: # enable configuration changes (to all)
map: # provide a map of tracked devices
conversation: # Allows you to issue voice commands from the frontend in enabled browsers
logbook: # View all events in a logbook

## do updates automatically (including sub-components)

updater:
  include_used_components: true

## Enables support for tracking state changes over time.
history: !include history.yaml

###
### SIMPLE
###

## Text to speech (using Google)
tts:
  platform: google

## IFTTT (key in secrets.yaml)
ifttt:
  key: !secret ifttt_key

###
### HTTP (web interface; see "frontend")
###

http:
  api_password: !secret http_api_password
  trusted_networks: 
    - 192.168.1.0/24
    - 172.30.33.0/24
  cors_allowed_origins: 
    - https://google.com
    - https://home-assistant.io
    - http://dcmartin.com
  base_url: 192.168.1.26:8123

###
### EXTERNAL IP
###

## simple REST sensor that parses JSON payload received
sensor external_ip:
  - platform: rest
    resource: http://ip.jsontest.com
    name: externalip
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.ip | default(null) }}
      {%- else -%} 0 {%- endif -%}

###
### SUN
###

## set the elevation (IDK if necessary)
sun:
  elevation: 827

## use elevation to calculate new sensors
sensor solar:
  platform: template
  sensors:
    solar_angle:
      value_template: '{{ states.sun.sun.attributes.elevation }}'
      unit_of_measurement: 'degrees'
    sunrise:
      value_template: '{{ as_timestamp(states.sun.sun.attributes.next_rising) | timestamp_custom("%I:%M %p") }}'
    sunset:
      value_template: '{{ as_timestamp(states.sun.sun.attributes.next_setting) | timestamp_custom("%I:%M %p") }}'

###
### MQTT (install using hassio)
###

## broker is LAN IP address of this instance
mqtt:
  broker: 192.168.1.26
  keepalive: 60
  client_id: homeassistant
  # port:
  # username:
  # password:

###
### HUE bridge & lights
###

## specify LAN IP address for Hue bridge device (should be discovered; see "discovery")
hue:
  bridges:
    - host: 192.168.1.49

###
### TPLINK switches
###

switch tplink-hs100:
  - platform: tplink
    name: poolhouse
    host: 192.168.1.42

switch tplink-hs105:
  - platform: tplink
    name: fronthall
    host: 192.168.1.43

###
### PANEL_IFRAME (tabs in HTTP web interface; see "frontend")
###

panel_iframe:
  docsis:
    title: 'Mikrotik'
    icon: mdi:router-wireless
    url: 'http://192.168.1.1'
  classify:
    title: 'CLASSIFY'
    icon: mdi:image-filter
    url: 'http://age-at-home.dcmartin.com/classify.html'
  digits:
    title: 'DIGITS-TX2'
    icon: mdi:format-list-numbers
    url: 'http://digits.dcmartin.com:5001'
  dima:
    title: 'DIGITS-DR'
    icon: mdi:format-list-numbers
    url: 'http://169.50.131.114:5001/'
  rpi2:
    title: 'mtn_rpi2'
    icon: mdi:image-filter-hdr
    url: 'http://192.168.1.26/dashboard'
  terminal:
    title: Terminal
    icon: mdi:console
    url: 'http://192.168.1.26:7681'
  cameras:
    title: Cameras
    icon: mdi:webcam
    url: 'http://192.168.1.32/LOCAL.html'

###
### SENSORS
###

## calculate list of devices tracked by GPS; n.b. sun.sun forces periodic re-evaluation
sensor state_template gps_trackers:
  - platform: template
    sensors:
      all_gps:
        entity_id: 
          - states.device_tracker
          - sun.sun
        value_template: >
          {%- for state in states.device_tracker -%}
            {%- if loop.first -%}
              {"date":{{ (now().timestamp()|int) }},"list":[
            {%- endif -%}
            {%- if state.attributes.source_type == 'gps' and state.attributes.device_status == 'online' -%}
              {{state.entity_id.replace('device_tracker.','')|truncate(8,false,"")|tojson}},
            {%- endif -%}
          {%- endfor -%}null]}

## calculate list of webcams 
sensor state_template webcam_trackers:
  - platform: template
    sensors:
      all_wcv80n:
        entity_id: states.camera
        value_template: >
          {%- for state in states.camera -%}
            {%- if loop.first -%} [ {%- endif -%}
            {%- if state.name.startswith('wcv80n') -%} 
              "{{state.name.replace('wcv80n_','')}}",
            {%- endif -%}
          {%- endfor -%}null]

###
### FFMPEG motion detection (this is a test)
###

## initiate FFMPEG
ffmpeg:

## binary indicator of motion
binary_sensor backyardmotion:
  - platform: ffmpeg_motion
    input: !secret backyardvideo
    name: backyardmotion
    extra_arguments: -pred 1 -q:v 2
    # device_class: motion
    # initial_state: false
    # changes: 5
    # reset: 20
    # repeats: 0
    # repeat_time: 0
    # ffmpeg_bin: /usr/bin/ffmpeg
    # ffmpeg_bin: /usr/bin/avconv

###
### HORIZON
###

#horizon:
#  username: dcmartin
#  password: !secret horizon_password
#  wallet: !secret horizon_wallet
#  publicid: !secret horizon_public_id
#   pattern: sdr-gps-netspeed
#  workload:
#    - sdr
#            type: realtek
#    - gps
#            accuracy: 1000 # meters (fuzzed)
#    - netspeed
#            location: automatic
#        - purpleair
#            username: !secret purpleair_username
#            password: !secret purpleair_password
#    - motion
#            event_gap: 5         
#        locate_mode: on
#        output_pictures: center
#            threshold: 1500
#                threshold_tune: on
#                mqtt_host: 192.168.1.26
#                mqtt_picture: on
#                stream_port: 8081

###
### WATSON IOT PLATFORM (TBD)
###

#watson_iotp:
#  org_id: hk31l6
#  auth_method: token
#  device_type: ageathome
#  device_id: rough-fog
#  auth_token: !secret wiotp_auth_token
# NEW w/ HORIZON
#  wiotp_org_id: hk3116
#  wiotp_api_key: !secret wiotp_api_key
#  wiotp_api_auth_token: !secret wiotp_auth_token
#  wiotp_device_type: ageathome
#  wiotp_device_auth_token: !secret wiotp_device_auth_token
#  hzn_device_id: {{ states.horizon.attributes.device_id }} 

###
### MOTION PACKAGE AS "ADD-ON"
###

#motion rough-fog:
#  name: kitchen
#  server: 192.168.1.26
#  webcontrol_port: 8080
#  stream_port: 8081
#  username: !secret motion_username
#  password: !secret motion_password
#  broker: 192.168.1.26

#binary_sensor motion_rpi2_onoff:
#  platform: motion
#  locate_motion_mode: off
#  locate_motion_style: box
#  threshold: 1500
#  threshold_tune: on

#
# MOTION PACKAGE w/ EXPOSED OPTIONS
#

#camera motion_rpi2:
#  platform: motion
#  text_right: %Y-%m-%d\n%T-%q
#  text_left: (not defined)
#  text_changes: off
#  text_event: %Y%m%d%H%M%S
#  text_double: off
#  noise_level: 32
#  noise_tune: on
#  despeckle_filter: EedDl
#  area_detect: (not defined)
#  mask_file: (not defined)
#  smart_mask_speed: 0
#  lightswitch: 0
#  minimum_motion_frames: 1
#  pre_capture: 0
#  post_capture: 0
#  event_gap: 5
#  max_movie_time: 0
#  emulate_motion: off
#  output_pictures: center
#  output_debug_pictures: off
#  quality: 100
#  picture_type: jpeg
#  ffmpeg_output_movies: off
#  ffmpeg_output_debug_movies: off
#  ffmpeg_timelapse: 0
#  ffmpeg_timelapse_mode: daily
#  ffmpeg_bps: 500000
#  ffmpeg_variable_bitrate: 0
#  ffmpeg_video_codec: mpeg4
#  ffmpeg_deinterlace: off
#  stream_port: 8081
#  stream_quality: 50
#  stream_motion: off
#  stream_maxrate: 1
#  stream_localhost: off
#  stream_limit: 0


###
### AGEATHOME - ENTITY LISTS 
###

## people - statically defined known entities to track
## devices - discovered devices from device_tracker entities where "friendly_name" has "ageathome_" prefix
## locations - discovered locations from camera entities where "name" has "ageathome_" prefix

sensor state_template:
  - platform: template
    sensors:
      ageathome_people:
        entity_id: 
          - sensor.ageathome_locations
        value_template: >
          {{ [ 'david','keli','hali','ian','riley','ellen' ] }}
      ageathome_devices:
        entity_id: 
          - states.device_tracker
          - sensor.ageathome_locations
        value_template: >
          {%- for state in states.device_tracker -%}
            {%- if loop.first -%}
              {"date":{{ (now().timestamp()|int) }},"devices":[
            {%- endif -%}
            {%- if state.attributes.friendly_name.startswith('ageathome_') -%}
              {"device":"{{state.entity_id.replace('device_tracker.','')}}","location":"{{state.attributes.friendly_name.replace('ageathome_','')}}"},
            {%- endif -%}
          {%- endfor -%}null]}
      ageathome_locations:
        entity_id: states.camera
        value_template: >
          {%- for state in states.camera -%}
            {%- if loop.first -%} {"date":{{ (now().timestamp()|int) }},"locations":[ {%- endif -%}
            {%- if state.name.startswith('ageathome') -%} 
              {"camera":"{{state.entity_id.replace('camera.','')}}","location":"{{state.name.replace('ageathome_','')}}"},
            {%- endif -%}
          {%- endfor -%}null]}

###
### SONOS
###

media_player sonos:
  - platform: sonos

## short-cut sensors for sonos in kitchen
sensor sonos_play1:
  platform: template
  sensors:
    play1_state:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.state }}'
    play1_volume:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.attributes.volume_level }}'
    play1_volume_muted:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.attributes.volume_muted }}'
    play1_media_content_id:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.attributes.media_content_id }}'
    play1_media_content_type:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.attributes.media_content_type }}'
    play1_media_duration:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.attributes.media_duration }}'
    play1_media_title:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.attributes.media_title }}'
    play1_media_artist:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.attributes.media_artist }}'
    play1_media_album_name:
      entity_id: media_player.play1
      value_template: '{{ states.media_player.play1.attributes.media_album_name }}'

## track history of sonos paused
sensor play1_paused:
  - platform: history_stats
    icon: mdi:speaker
    name: play1_paused
    entity_id: sensor.play1_state
    state: 'paused'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

## sonos in livingroom
sensor sonos_play3:
  - platform: template
    sensors:
      play3_state:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.state }}'
      play3_volume:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.attributes.volume_level }}'
      play3_volume_muted:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.attributes.volume_muted }}'
      play3_media_content_id:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.attributes.media_content_id }}'
      play3_media_content_type:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.attributes.media_content_type }}'
      play3_media_duration:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.attributes.media_duration }}'
      play3_media_title:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.attributes.media_title }}'
      play3_media_artist:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.attributes.media_artist }}'
      play3_media_album_name:
        entity_id: media_player.play3
        value_template: '{{ states.media_player.play3.attributes.media_album_name }}'

sensor play3_paused:
  - platform: history_stats
    icon: mdi:speaker
    name: play3_paused
    entity_id: sensor.play3_state
    state: 'paused'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

###
### DEVICE TRACKERS
###

## device tracking from this host
device_tracker dt_nmap:
  - platform: nmap_tracker
    hosts: 192.168.1.1/24
    home_interval: 10
    track_new_devices: yes
    consider_home: 180
    exclude:
     - 192.168.1.26

## device tracking from iCloud
device_tracker:
  - platform: icloud
    username: !secret icloud_username
    password: !secret icloud_password
    account_name: DCMARTIN

## device tracking from LAN/WAN gateway 
  - platform: mikrotik
    host: 192.168.1.1
    username: !secret mikrotik_username
    password: !secret mikrotik_password

###
### ZONES
###

zone: !include zones.yaml

###
### NOTIFY
###

## iOS notifications (single targer)

notify ios:
  - platform: ios
    name: davids_iphone
    target: !secret notify_target

###
### PLEX
###

## media player
media_player david_plex:
  - platform: plex
    name: david_plex
    ip_address: 192.168.1.32
    port: 32400
    token: !secret plex_token

## sensor
sensor david_plex:
  - platform: plex
    host: 192.168.1.32
    port: 32400
    name: david_plex
    username: !secret plex_username
    password: !secret plex_password

###
### WEATHER
###

## weathermap forecast
camera weatherforecast:
  - platform: generic
    name: weatherforecast
    still_image_url: 'https://www.yr.no/sted/USA/California/San_Francisco/meteogram.svg'
    content_type: 'image/svg+xml'

## weather underground radar
camera wuradar:
  - platform: generic
    name: wuradar
    still_image_url: 'https://icons.wxug.com/data/weather-maps/radar/united-states/bakersfield-california-region-current-radar-animation.gif'

## WEATHER UNDERGROUND (requires account; see secrets.yaml)
sensor kcasanjo411:
  - platform: wunderground
    api_key: !secret wunderground_api_key
    pws_id: KCASANJO411
    monitored_conditions:
      - weather
      - feelslike_f
      - precip_today_in
      - relative_humidity
      - visibility_mi
      - wind_dir
      - wind_gust_mph
      - wind_mph
      - weather_1d
      - weather_1n
      - weather_2d
      - weather_2n
      - weather_3d
      - weather_3n
      - weather_4d
      - weather_4n

###
### WEBCAMS
###

## all Linksys/Cisco WCV80N cameras
camera wcv80n_woodshed:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.163/img/video.mjpeg
    still_image_url: http://192.168.1.163/img/snapshot.cgi
    name: wcv80n_woodshed
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_livingroom:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.164/img/video.mjpeg
    still_image_url: http://192.168.1.164/img/snapshot.cgi
    name: wcv80n_livingroom
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_poolhouse_fridge:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.165/img/video.mjpeg
    still_image_url: http://192.168.1.165/img/snapshot.cgi
    name: wcv80n_poolhouse_fridge
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_interior_gate:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.166/img/video.mjpeg
    still_image_url: http://192.168.1.166/img/snapshot.cgi
    name: wcv80n_interior_gate
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_kitchen:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.167/img/video.mjpeg
    still_image_url: http://192.168.1.167/img/snapshot.cgi
    name: wcv80n_kitchen
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_poolhouse_exterior:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.168/img/video.mjpeg
    still_image_url: http://192.168.1.168/img/snapshot.cgi
    name: wcv80n_poolhouse_exterior
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_dogyard:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.169/img/video.mjpeg
    still_image_url: http://192.168.1.169/img/snapshot.cgi
    name: wcv80n_dogyard
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_dogshedmiddle:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.170/img/video.mjpeg
    still_image_url: http://192.168.1.170/img/snapshot.cgi
    name: wcv80n_dogshedmiddle
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_dogshedfront:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.172/img/video.mjpeg
    still_image_url: http://192.168.1.172/img/snapshot.cgi
    name: wcv80n_dogshedfront
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_dogshed_interior:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.173/img/video.mjpeg
    still_image_url: http://192.168.1.173/img/snapshot.cgi
    name: wcv80n_dogshed_interior
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_pondview:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.174/img/video.mjpeg
    still_image_url: http://192.168.1.174/img/snapshot.cgi
    name: wcv80n_pondview
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_gravelpad:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.175/img/video.mjpeg
    still_image_url: http://192.168.1.175/img/snapshot.cgi
    name: wcv80n_gravelpad
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_upperpath:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.176/img/video.mjpeg
    still_image_url: http://192.168.1.176/img/snapshot.cgi
    name: wcv80n_upperpath
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_laundry:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.177/img/video.mjpeg
    still_image_url: http://192.168.1.177/img/snapshot.cgi
    name: wcv80n_laundry
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_foyer:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.178/img/video.mjpeg
    still_image_url: http://192.168.1.178/img/snapshot.cgi
    name: wcv80n_foyer
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_frontwalk:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.179/img/video.mjpeg
    still_image_url: http://192.168.1.179/img/snapshot.cgi
    name: wcv80n_frontwalk
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_dogpond:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.180/img/video.mjpeg
    still_image_url: http://192.168.1.180/img/snapshot.cgi
    name: wcv80n_dogpond
    username: !secret wcv80n_username
    password: !secret wcv80n_password

#camera wcv80n_poolhousestereo:
#  - platform: mjpeg
#    mjpeg_url: http://192.168.1.181/img/video.mjpeg
#    still_image_url: http://192.168.1.181/img/snapshot.cgi
#    name: wcv80n_poolhousestereo
#    username: !secret wcv80n_username
#    password: !secret wcv80n_password

camera wcv80n_diningroom:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.182/img/video.mjpeg
    still_image_url: http://192.168.1.182/img/snapshot.cgi
    name: wcv80n_diningroom
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera wcv80n_backyard:
  - platform: mjpeg
    mjpeg_url: http://192.168.1.183/img/video.mjpeg
    still_image_url: http://192.168.1.183/img/snapshot.cgi
    name: wcv80n_backyard
    username: !secret wcv80n_username
    password: !secret wcv80n_password

###
### HORIZON
###

## STATUS

# CONFIGURATION

sensor hzn_connectivity:
  - platform: rest
    resource: 'http://192.168.1.26/status'
    name: horizon_connectivity
    value_template: >
      {%- if value_json is defined and value_json.configuration is defined -%} 
        {{ value_json.connectivity | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_exchange:
  - platform: rest
    resource: 'http://192.168.1.26/status'
    name: horizon_exchange
    value_template: >
      {%- if value_json is defined and value_json.configuration is defined -%} 
        {{ value_json.configuration.exchange_api | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_architecture:
  - platform: rest
    resource: 'http://192.168.1.26/status'
    name: horizon_architecture
    value_template: >
      {%- if value_json is defined and value_json.configuration is defined -%} 
        {{ value_json.configuration.architecture | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

# ETHEREUM

sensor hzn_balance:
  - platform: rest
    resource: 'http://192.168.1.26/status'
    name: horizon_balance
    value_template: >
      {%- if value_json is defined -%}
        {%- if value_json.geth is defined -%}
          {%- if value_json.geth != [] -%} 
            {{ value_json.geth.eth_balance|int }}
          {%- else -%}
            0
          {%- endif -%}
        {%- else -%}
          -1
        {%- endif -%}
      {%- else -%}
        'undefined'
      {%- endif -%}

sensor hzn_peer_count:
  - platform: rest
    resource: 'http://192.168.1.26/status'
    name: horizon_net_peer_count
    value_template: >
      {%- if value_json is defined -%}
        {%- if value_json.geth is defined -%}
          {%- if value_json.geth != [] -%} 
            {{ value_json.geth.net_peer_count|int }}
          {%- else -%}
            0
          {%- endif -%}
        {%- else -%}
          -1
        {%- endif -%}
      {%- else -%}
        'undefined'
      {%- endif -%}

sensor hzn_syncing:
  - platform: rest
    resource: 'http://192.168.1.26/status'
    name: horizon_syncing
    value_template: >
      {%- if value_json is defined -%}
        {%- if value_json.geth is defined -%}
          {%- if value_json.geth != [] -%} 
            {{ value_json.geth.eth_syncing }}
          {%- else -%}
            null
          {%- endif -%}
        {%- else -%}
          'undefined'
        {%- endif -%}
      {%- else -%}
        'undefined'
      {%- endif -%}

sensor hzn_blocknumber:
  - platform: rest
    resource: 'http://192.168.1.26/status'
    name: horizon_blocknumber
    value_template: >
      {%- if value_json is defined -%}
        {%- if value_json.geth is defined -%}
          {%- if value_json.geth != [] -%} 
            {{ value_json.geth.eth_blocknumber|int }}
          {%- else -%}
            0
          {%- endif -%}
        {%- else -%}
          -1
        {%- endif -%}
      {%- else -%}
        'undefined'
      {%- endif -%}

sensor hzn_account:
  - platform: rest
    resource: 'http://192.168.1.26/status'
    name: horizon_account
    value_template: >
      {%- if value_json is defined -%}
        {%- if value_json.geth is defined -%}
          {%- if value_json.geth != [] -%} 
            {{ value_json.geth.eth_accounts[0] }}
          {%- else -%}
            null
          {%- endif -%}
        {%- else -%}
          'undefined'
        {%- endif -%}
      {%- else -%}
        'undefined'
      {%- endif -%}

## NODE

sensor hzn_node_id:
  - platform: rest
    resource: 'http://192.168.1.26/node'
    name: horizon_node_id
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.id | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_node_organization:
  - platform: rest
    resource: 'http://192.168.1.26/node'
    name: horizon_node_organization
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.organization | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_node_pattern:
  - platform: rest
    resource: 'http://192.168.1.26/node'
    name: horizon_node_pattern
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.pattern | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_node_name:
  - platform: rest
    resource: 'http://192.168.1.26/node'
    name: horizon_node_name
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.name | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_node_valid:
  - platform: rest
    resource: 'http://192.168.1.26/node'
    name: horizon_node_valid
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.token_valid | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_node_valid_time:
  - platform: rest
    resource: 'http://192.168.1.26/node'
    name: horizon_node_valid_time
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.token_valid|int|timestamp_custom("%a %b %d @ %I:%M %p") | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

# CONFIG

sensor hzn_node_state:
  - platform: rest
    resource: 'http://192.168.1.26/node'
    name: horizon_node_state
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.configstate.state | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_node_update:
  - platform: rest
    resource: 'http://192.168.1.26/node'
    name: horizon_node_update
    value_template: >
      {%- if value_json is defined -%} 
        {{ value_json.configstate.last_update_time|int|timestamp_custom("%a %b %d @ %I:%M %p") | default(null) }}
      {%- else -%} 'undefined' {%- endif -%}

## MICROSERVICE

sensor hzn_microservice_config_count:
  - platform: rest
    resource: 'http://192.168.1.26/microservice'
    name: horizon_microservice_config_count
    value_template: >
      {%- if value_json is defined and value_json.config is defined -%} 
        {{ ( value_json.config | length ) | default(0)  }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_microservice_instance_active_count:
  - platform: rest
    resource: 'http://192.168.1.26/microservice'
    name: horizon_microservice_instance_active_count
    value_template: >
      {%- if value_json is defined and value_json.instances is defined -%} 
        {{ ( value_json.instances.active | length ) | default(0) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_microservice_instance_archived_count:
  - platform: rest
    resource: 'http://192.168.1.26/microservice'
    name: horizon_microservice_instance_archived_count
    value_template: >
      {%- if value_json is defined and value_json.instances is defined -%} 
        {{ ( value_json.instances.archived | length ) | default(0) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_microservice_definition_active_count:
  - platform: rest
    resource: 'http://192.168.1.26/microservice'
    name: horizon_microservice_definition_active_count
    value_template: >
      {%- if value_json is defined and value_json.definitions is defined -%} 
        {{ ( value_json.definitions.active | length ) | default(0) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_microservice_definition_archived_count:
  - platform: rest
    resource: 'http://192.168.1.26/microservice'
    name: horizon_microservice_definition_archived_count
    value_template: >
      {%- if value_json is defined and value_json.definitions is defined -%} 
        {{ ( value_json.definitions.archived | length ) | default(0) }}
      {%- else -%} 'undefined' {%- endif -%}

## ATTRIBUTE

sensor hzn_attribute_count:
  - platform: rest
    resource: 'http://192.168.1.26/attribute'
    name: horizon_attribute_count
    value_template: >
      {%- if value_json is defined -%} 
        {{ ( value_json.attributes | length ) | default(0) }}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_attribute_ids:
  - platform: rest
    resource: 'http://192.168.1.26/attribute'
    name: horizon_attribute_ids
    value_template: >
      {%- if value_json is defined and value_json.attributes|length > 0 -%} 
        {%- for attribute in value_json.attributes -%}
          {%- if loop.last -%}
            {%- if attribute.id != None -%}
              {{- attribute.id|truncate(8,false,'')|tojson -}}
            {%- endif -%}
          {%- else -%}
            {%- if attribute.id != None -%}
              {{- attribute.id|truncate(8,false,'')|tojson -}},
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- else -%} 'undefined' {%- endif -%}

## HORIZON AGREEMENT

sensor hzn_agreement_active_count:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement_active_count
    value_template: >
      {%- if value_json is defined -%} 
        {{ ( value_json.agreements.active | length ) | default(0) }}
      {%- else -%} 0 {%- endif -%}

sensor hzn_agreement_active_ids:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement_active_ids
    value_template: >
      {%- if value_json is defined and value_json.agreements.active|length > 0 -%} 
        {%- for agreement in value_json.agreements.active %}
          {%- if loop.last -%}
            {%- if agreement.current_agreement_id != None -%}
              {{- agreement.current_agreement_id|tojson -}}
            {%- endif -%}
          {%- else -%}
            {%- if agreement.current_agreement_id != None -%}
              {{- agreement.current_agreement_id|tojson -}},
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_agreement_active_urls:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement_active_urls
    value_template: >
      {%- if value_json is defined and value_json.agreements.active|length > 0 -%} 
        {%- for agreement in value_json.agreements.active %}
          {%- if loop.last -%}
            {%- if agreement.workload_to_run.url != None -%}
              {{- agreement.workload_to_run.url|tojson -}}
            {%- endif -%}
          {%- else -%}
            {%- if agreement.workload_to_run.url != None -%}
              {{- agreement.workload_to_run.url|tojson -}},
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- else -%} 'undefined' {%- endif -%}

sensor hzn_agreement_archived_count:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement_archived_count
    value_template: >
      {%- if value_json is defined -%} 
        {{ ( value_json.agreements.archived | length ) | default(0) }}
      {%- else -%} 0 {%- endif -%}

# HORIZON WORKLOAD

sensor hzn_workload_container_count:
  - platform: rest
    resource: 'http://192.168.1.26/workload'
    name: horizon_workload_container_count
    value_template: >
      {%- if value_json is defined -%} 
        {{ ( value_json.containers | length ) | default(0) }}
      {%- else -%} 'undefined' {%- endif -%}

## AGREEMENTS

# AGREEMENT #0

sensor hzn_agreement0_name:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_name
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].name | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement0_id:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_id
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].current_agreement_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement0_consumer:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_consumer
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].consumer_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement0_counterparty:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_counterparty
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].counterparty_address | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement0_protocol:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_protocol
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].agreement_protocol | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement0_create:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_create
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
          {{ value_json.agreements.active[0].agreement_creation_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement0_accept:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_accept
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].agreement_accepted_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement0_finalize:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_finalize
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].agreement_finalized_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement0_receive:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_receive
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].agreement_data_received_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement0_start:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement0_start
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 0 -%} 
        {{ value_json.agreements.active[0].agreement_execution_start_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

# AGREEMENT #1

sensor hzn_agreement1_name:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_name
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].name | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement1_id:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_id
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].current_agreement_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement1_consumer:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_consumer
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].consumer_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement1_counterparty:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_counterparty
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].counterparty_address | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement1_protocol:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_protocol
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].agreement_protocol | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement1_create:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_create
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
          {{ value_json.agreements.active[1].agreement_creation_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement1_accept:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_accept
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].agreement_accepted_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement1_finalize:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_finalize
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].agreement_finalized_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement1_receive:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_receive
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].agreement_data_received_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement1_start:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement1_start
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 1 -%} 
        {{ value_json.agreements.active[1].agreement_execution_start_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

# AGREEMENT #2

sensor hzn_agreement2_name:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_name
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].name | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement2_id:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_id
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].current_agreement_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement2_consumer:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_consumer
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].consumer_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement2_counterparty:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_counterparty
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].counterparty_address | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement2_protocol:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_protocol
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].agreement_protocol | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement2_create:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_create
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
          {{ value_json.agreements.active[2].agreement_creation_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement2_accept:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_accept
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].agreement_accepted_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement2_finalize:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_finalize
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].agreement_finalized_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement2_receive:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_receive
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].agreement_data_received_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement2_start:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement2_start
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 2 -%} 
        {{ value_json.agreements.active[2].agreement_execution_start_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

# AGREEMENT #3

sensor hzn_agreement3_name:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_name
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].name | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement3_id:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_id
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].current_agreement_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement3_consumer:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_consumer
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].consumer_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement3_counterparty:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_counterparty
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].counterparty_address | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement3_protocol:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_protocol
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].agreement_protocol | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement3_create:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_create
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
          {{ value_json.agreements.active[3].agreement_creation_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement3_accept:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_accept
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].agreement_accepted_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement3_finalize:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_finalize
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].agreement_finalized_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement3_receive:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_receive
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].agreement_data_received_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement3_start:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement3_start
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 3 -%} 
        {{ value_json.agreements.active[3].agreement_execution_start_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

# AGREEMENT #4

sensor hzn_agreement4_name:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_name
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].name | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement4_id:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_id
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].current_agreement_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement4_consumer:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_consumer
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].consumer_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement4_counterparty:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_counterparty
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].counterparty_address | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement4_protocol:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_protocol
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].agreement_protocol | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement4_create:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_create
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
          {{ value_json.agreements.active[4].agreement_creation_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement4_accept:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_accept
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].agreement_accepted_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement4_finalize:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_finalize
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].agreement_finalized_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement4_receive:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_receive
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].agreement_data_received_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement4_start:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement4_start
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 4 -%} 
        {{ value_json.agreements.active[4].agreement_execution_start_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

# AGREEMENT #5

sensor hzn_agreement5_name:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_name
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].name | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement5_id:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_id
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].current_agreement_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement5_consumer:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_consumer
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].consumer_id | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement5_counterparty:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_counterparty
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].counterparty_address | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement5_protocol:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_protocol
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].agreement_protocol | default(null) }}
      {%- else -%} null {%- endif -%}

sensor hzn_agreement5_create:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_create
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
          {{ value_json.agreements.active[5].agreement_creation_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement5_accept:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_accept
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].agreement_accepted_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement5_finalize:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_finalize
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].agreement_finalized_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement5_receive:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_receive
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].agreement_data_received_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

sensor hzn_agreement5_start:
  - platform: rest
    resource: 'http://192.168.1.26/agreement'
    name: horizon_agreement5_start
    value_template: >
      {%- if value_json is defined and states('sensor.horizon_agreement_active_count')|int > 5 -%} 
        {{ value_json.agreements.active[5].agreement_execution_start_time | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}
        {{ 'no agreement' }}
      {%- endif -%}

###
### AGE-AT-HOME
###

##
## CAMERAS (motion package)
##

camera roughfog:
  - platform: mjpeg
    name: ageathome_kitchen
    mjpeg_url: http://192.168.1.34:8081/
    authentication: basic
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera dampcloud:
  - platform: mjpeg
    name: ageathome_bathroom
    mjpeg_url: http://192.168.1.35:8081/
    authentication: basic
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera quietwater:
  - platform: mjpeg
    name: ageathome_road
    mjpeg_url: http://192.168.1.36:8081/
    authentication: basic
    username: !secret wcv80n_username
    password: !secret wcv80n_password

camera roughwind:   
  - platform: mjpeg
    name: ageathome_frontdoor
    mjpeg_url: http://192.168.1.37:8081/
    authentication: basic
    username: !secret wcv80n_username
    password: !secret wcv80n_password

##
## STATUS CATCHERS
##

sensor count_lights:
  - platform: mqtt
    name: count_lights
    state_topic: 'state/light/+'
    value_template: >
      {% if value_json is defined %} {{ value_json['items'] | length }} {% else %} 0 {% endif %}

sensor count_automations:
  - platform: mqtt
    name: count_automations
    state_topic: 'state/automation/+'
    value_template: >
      {% if value_json is defined %} {{ value_json['items'] | length }} {% else %} 0 {% endif %}

sensor count_binary_sensors:
  - platform: mqtt
    name: count_binary_sensors
    state_topic: 'state/binary_sensor/+'
    value_template: >
      {% if value_json is defined %} {{ value_json['items'] | length }} {% else %} 0 {% endif %}

sensor count_cameras:
  - platform: mqtt
    name: count_cameras
    state_topic: 'state/camera/+'
    value_template: >
      {% if value_json is defined %} {{ value_json['items'] | length }} {% else %} 0 {% endif %}

sensor count_device_trackers:
  - platform: mqtt
    name: count_device_trackers
    state_topic: 'state/device_tracker/+'
    value_template: >
      {% if value_json is defined %} {{ value_json['items'] | length }} {% else %} 0 {% endif %}

sensor triggered_template:
  - platform: template
    sensors:
      triggered_device_trackers:
        entity_id: automation.publish_device_trackers
        value_template: >
         {{ as_timestamp(states.automation.publish_device_trackers.attributes.last_triggered) | timestamp_custom("%a %b %d @ %I:%M %p") }}

sensor count_media_players:
  - platform: mqtt
    name: count_media_players
    state_topic: 'state/media_player/+'
    value_template: >
      {% if value_json is defined %} {{ value_json['items'] | length }} {% else %} 0 {% endif %}

sensor count_sensors:
  - platform: mqtt
    name: count_sensors
    state_topic: 'state/sensor/+'
    value_template: >
      {% if value_json is defined %} {{ value_json['items'] | length }} {% else %} 0 {% endif %}

sensor count_zones:
  - platform: mqtt
    name: count_zones
    state_topic: 'state/zone/+'
    value_template: >
      {% if value_json is defined %} {{ value_json['items'] | length }} {% else %} 0 {% endif %}

##
## ERRORS
##

sensor error:
  - platform: mqtt
    state_topic: 'error/+'
    name: error
    value_template: '{% if value_json is defined %} {{ value_json }} {% else %} "nothing" {% endif %}'
     
sensor error_id:
  - platform: mqtt
    state_topic: 'error/+'
    name: error_id
    value_template: '{% if value_json is defined %} {{ value_json.id }} {% else %} "nothing" {% endif %}'

sensor error_device:
  - platform: mqtt
    state_topic: 'error/+'
    name: error_device
    value_template: '{% if value_json is defined %} {{ value_json.device }} {% else %} "nothing" {% endif %}'

camera error_image:
  - platform: generic
    name: error_image
    still_image_url: 'http://192.168.1.32/CGI/aah-images.cgi?db={{states.sensor.error_device.state}}&id={{states.sensor.error_id.state}}&ext=full'

##
## WRONG
##

sensor aah_wrong_device:
  - platform: mqtt
    name: aah_wrong_device
    state_topic: 'wrong/#'
    value_template: '{% if value_json is defined %} {{ value_json.device }} {% else %} "none" {% endif %}'

sensor aah_wrong_id:
  - platform: mqtt
    name: aah_wrong_id
    state_topic: 'wrong/#'
    value_template: '{% if value_json is defined %} {{ value_json.id }} {% else %} "none" {% endif %}'

sensor aah_wrong_what:
  - platform: mqtt
    state_topic: 'wrong/#'
    name: aah_wrong_what
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor aah_wrong_who:
  - platform: mqtt
    state_topic: 'wrong/#'
    name: aah_wrong_who
    value_template: '{% if value_json is defined %} {{ value_json.model }} {% else %} "nobody" {% endif %}'

sensor aah_wrong_why:
  - platform: mqtt
    state_topic: 'wrong/#'
    name: aah_wrong_why
    value_template: '{% if value_json is defined %} {{ value_json.score }} {% else %} 0.0 {% endif %}'

sensor aah_wrong_date:
  - platform: mqtt
    state_topic: 'wrong/#'
    name: aah_wrong_date
    value_template: '{% if value_json is defined -%} {{ value_json.date|int }} {%- else -%} -1 {%- endif -%}'

sensor aah_wrong_where:
  - platform: mqtt
    state_topic: 'wrong/#'
    name: aah_wrong_where
    value_template: '{% if value_json is defined %} {{ value_json.location }} {% else %} "nowhere" {% endif %}'

sensor aah_wrong_when:
  - platform: mqtt
    state_topic: 'wrong/#'
    name: aah_wrong_when
    value_template: '{% if value_json is defined %} {{ value_json.date | timestamp_custom("%a %b %d @ %I:%M %p") }} {% else %} "never" {% endif %}'
    icon_template: >-
      {% if ((states.sensor.aah_wrong_date.state|int) | timestamp_custom("%p")) == "PM" %}
        mdi:weather-night
      {% else %}
        mdi:weather-sunny
      {% endif %}

##
## LAST ACTIVITY
##

sensor last_device:
  - platform: mqtt
    name: last_device
    state_topic: 'presence/+'
    value_template: '{% if value_json is defined %} {{ value_json.device }} {% else %} "none" {% endif %}'

sensor last_id:
  - platform: mqtt
    name: last_id
    state_topic: 'presence/+'
    value_template: '{% if value_json is defined %} {{ value_json.id }} {% else %} "none" {% endif %}'

sensor last_what:
  - platform: mqtt
    state_topic: 'presence/+'
    name: last_what
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor last_who:
  - platform: mqtt
    state_topic: 'presence/+'
    name: last_who
    value_template: '{% if value_json is defined %} {{ value_json.model }} {% else %} "nobody" {% endif %}'

sensor last_why:
  - platform: mqtt
    state_topic: 'presence/+'
    name: last_why
    value_template: '{% if value_json is defined %} {{ value_json.score }} {% else %} 0.0 {% endif %}'

sensor last_date:
  - platform: mqtt
    state_topic: 'presence/+'
    name: last_date
    value_template: '{% if value_json is defined -%} {{ value_json.date|int }} {%- else -%} -1 {%- endif -%}'

sensor last_where:
  - platform: mqtt
    state_topic: 'presence/+'
    name: last_where
    value_template: '{% if value_json is defined %} {{ value_json.location }} {% else %} "nowhere" {% endif %}'

sensor last_when:
  - platform: mqtt
    state_topic: 'presence/+'
    name: last_when
    value_template: '{% if value_json is defined %} {{ value_json.date | timestamp_custom("%a %b %d @ %I:%M %p") }} {% else %} "never" {% endif %}'
    icon_template: >-
      {% if ((states.sensor.last_date.state|int) | timestamp_custom("%p")) == "PM" %}
        mdi:weather-night
      {% else %}
        mdi:weather-sunny
      {% endif %}

# CAMERAS (JPEG)

camera last_image:
  - platform: mqtt
    name: last_image
    topic: 'image/+'

camera last_image_annotated:
  - platform: mqtt
    name: last_image_annotated
    topic: 'image-annotated/+'

camera last_image_cropped:
  - platform: mqtt
    name: last_image_cropped
    icon: mdi:image
    topic: 'image-cropped/+'

##
## KITCHEN
##

sensor kitchen_last:
  - platform: mqtt
    name: kitchen_last
    state_topic: 'presence/kitchen'
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor kitchen_what:
  - platform: mqtt
    name: kitchen_what
    expire_after: 30
    state_topic: 'presence/kitchen'
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor kitchen_who:
  - platform: mqtt
    name: kitchen_who
    state_topic: 'presence/kitchen'
    value_template: '{% if value_json is defined %} {{ value_json.model }} {% else %} "nobody" {% endif %}'

sensor kitchen_why:
  - platform: mqtt
    name: kitchen_why
    state_topic: 'presence/kitchen'
    value_template: '{% if value_json is defined %} {{ value_json.score }} {% else %} 0.0 {% endif %}'

sensor kitchen_date:
  - platform: mqtt
    name: kitchen_date
    icon: mdi:human-greeting
    state_topic: 'presence/kitchen'
    value_template: '{% if value_json is defined %} {{ value_json.date|int }} {% else %} -1 {% endif %}'

# CAMERA (JPEG)

camera kitchen_image:
  - platform: mqtt
    name: kitchen_image
    topic: 'image/kitchen'

camera kitchen_image_annotated:
  - platform: mqtt
    name: kitchen_image_annotated
    topic: 'image-annotated/kitchen'

camera kitchen_image_cropped:
  - platform: mqtt
    name: kitchen_image_cropped
    icon: mdi:image
    topic: 'image-cropped/kitchen'

##
## BATHROOM
##

sensor bathroom_last:
  - platform: mqtt
    name: bathroom_last
    state_topic: 'presence/bathroom'
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor bathroom_what:
  - platform: mqtt
    name: bathroom_what
    expire_after: 30
    state_topic: 'presence/bathroom'
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor bathroom_who:
  - platform: mqtt
    name: bathroom_who
    state_topic: 'presence/bathroom'
    value_template: '{% if value_json is defined %} {{ value_json.model }} {% else %} "nobody" {% endif %}'

sensor bathroom_why:
  - platform: mqtt
    name: bathroom_why
    state_topic: 'presence/bathroom'
    value_template: '{% if value_json is defined %} {{ value_json.score }} {% else %} 0.0 {% endif %}'

sensor bathroom_date:
  - platform: mqtt
    name: bathroom_date
    icon: mdi:human-greeting
    state_topic: 'presence/bathroom'
    value_template: '{% if value_json is defined %} {{ value_json.date|int }} {% else %} -1 {% endif %}'

# CAMERA (JPEG)

camera bathroom_image:
  - platform: mqtt
    name: bathroom_image
    topic: 'image/bathroom'

camera bathroom_image_annotated:
  - platform: mqtt
    name: bathroom_image_annotated
    topic: 'image-annotated/bathroom'

camera bathroom_image_cropped:
  - platform: mqtt
    name: bathroom_image_cropped
    topic: 'image-cropped/bathroom'

##
## ROAD
##

sensor road_last:
  - platform: mqtt
    name: road_last
    state_topic: 'presence/road'
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor road_what:
  - platform: mqtt
    name: road_what
    expire_after: 30
    state_topic: 'presence/road'
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor road_who:
  - platform: mqtt
    name: road_who
    state_topic: 'presence/road'
    value_template: '{% if value_json is defined %} {{ value_json.model }} {% else %} "nobody" {% endif %}'

sensor road_why:
  - platform: mqtt
    name: road_why
    state_topic: 'presence/road'
    value_template: '{% if value_json is defined %} {{ value_json.score }} {% else %} 0.0 {% endif %}'

sensor road_date:
  - platform: mqtt
    name: road_date
    icon: mdi:human-greeting
    state_topic: 'presence/road'
    value_template: '{% if value_json is defined %} {{ value_json.date|int }} {% else %} -1 {% endif %}'

# CAMERA (JPEG)

camera road_image:
  - platform: mqtt
    name: road_image
    icon: mdi:image
    topic: 'image/road'

camera road_image_annotated:
  - platform: mqtt
    name: road_image_annotated
    topic: 'image-annotated/road'

camera road_image_cropped:
  - platform: mqtt
    name: road_image_cropped
    topic: 'image-cropped/road'

##
## DETERMINISTIC INDICATOR OF CLASSIFIER FAILURE (100%)
##

binary_sensor classifier_wrong:
  platform: template
  sensors:
    kitchen_wrong:
      entity_id:
        - sensor.kitchen_what
      value_template: >
        {{ ( is_state('binary_sensor.david_home','off') and is_state('sensor.kitchen_what','david') ) or
           ( is_state('binary_sensor.keli_home','off') and is_state('sensor.kitchen_what','keli') ) or
           ( is_state('binary_sensor.hali_home','off') and is_state('sensor.kitchen_what','hali') ) or
           ( is_state('binary_sensor.ian_home','off') and is_state('sensor.kitchen_what','ian') ) or
           ( is_state('binary_sensor.riley_home','off') and is_state('sensor.kitchen_what','riley') ) or
           ( is_state('binary_sensor.ellen_home','off') and is_state('sensor.kitchen_what','ellen') ) }}
    bathroom_wrong:
      entity_id:
        - sensor.bathroom_what
      value_template: >
        {{ ( is_state('binary_sensor.david_home','off') and is_state('sensor.bathroom_what','david') ) or
           ( is_state('binary_sensor.keli_home','off') and is_state('sensor.bathroom_what','keli') ) or
           ( is_state('binary_sensor.hali_home','off') and is_state('sensor.bathroom_what','hali') ) or
           ( is_state('binary_sensor.ian_home','off') and is_state('sensor.bathroom_what','ian') ) or
           ( is_state('binary_sensor.riley_home','off') and is_state('sensor.bathroom_what','riley') ) or
           ( is_state('binary_sensor.ellen_home','off') and is_state('sensor.bathroom_what','ellen') ) }}
    frontdoor_wrong:
      entity_id:
        - sensor.frontdoor_what
      value_template: >
        {{ ( is_state('binary_sensor.david_home','off') and is_state('sensor.frontdoor_what','david') ) or
           ( is_state('binary_sensor.keli_home','off') and is_state('sensor.frontdoor_what','keli') ) or
           ( is_state('binary_sensor.hali_home','off') and is_state('sensor.frontdoor_what','hali') ) or
           ( is_state('binary_sensor.ian_home','off') and is_state('sensor.frontdoor_what','ian') ) or
           ( is_state('binary_sensor.riley_home','off') and is_state('sensor.frontdoor_what','riley') ) or
           ( is_state('binary_sensor.ellen_home','off') and is_state('sensor.frontdoor_what','ellen') ) }}
    road_wrong:
      entity_id:
        - sensor.road_what
      value_template: >
        {{ is_state('binary_sensor.david_home','on') and is_state('sensor.road_what','martin_c70') }}

##
## FRONTDOOR
##

sensor frontdoor_last:
  - platform: mqtt
    name: frontdoor_last
    state_topic: 'presence/frontdoor'
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor frontdoor_what:
  - platform: mqtt
    name: frontdoor_what
    expire_after: 30
    state_topic: 'presence/frontdoor'
    value_template: '{% if value_json is defined %} {{ value_json.class }} {% else %} "nothing" {% endif %}'

sensor frontdoor_who:
  - platform: mqtt
    name: frontdoor_who
    state_topic: 'presence/frontdoor'
    value_template: '{% if value_json is defined %} {{ value_json.model }} {% else %} "nobody" {% endif %}'

sensor frontdoor_why:
  - platform: mqtt
    name: frontdoor_why
    state_topic: 'presence/frontdoor'
    value_template: '{% if value_json is defined %} {{ value_json.score }} {% else %} 0.0 {% endif %}'

sensor frontdoor_date:
  - platform: mqtt
    name: frontdoor_date
    icon: mdi:human-greeting
    state_topic: 'presence/frontdoor'
    value_template: '{% if value_json is defined %} {{ value_json.date|int }} {% else %} -1 {% endif %}'

# CAMERA (JPEG)

camera frontdoor_image:
  - platform: mqtt
    name: frontdoor_image
    icon: mdi:image
    topic: 'image/frontdoor'

camera frontdoor_image_annotated:
  - platform: mqtt
    name: frontdoor_image_annotated
    icon: mdi:image
    topic: 'image-annotated/frontdoor'

camera frontdoor_image_cropped:
  - platform: mqtt
    name: frontdoor_image_cropped
    icon: mdi:image
    topic: 'image-cropped/frontdoor'

## MOTION SENSORS 

sensor motion_sensors:
  platform: template
  sensors:
    last_ago:
      entity_id:
        - sensor.last_date
        - sun.sun
      unit_of_measurement: seconds
      value_template: '{{ (now().timestamp()|int) - (states.sensor.last_date.state|int) }}'
      icon_template: '{% if (states.sensor.last_ago|int) > 300 %} mdi:timer-off {% else %} mdi:timer {% endif %}'
    kitchen_ago:
      entity_id: 
        - sensor.kitchen_date
        - sun.sun
      unit_of_measurement: seconds
      value_template: '{{ (now().timestamp()|int) - (states.sensor.kitchen_date.state|int) }}'
      icon_template: '{%- if (states.sensor.kitchen_ago.state|int) > 300 -%} mdi:timer-off {%- else -%} mdi:timer {%- endif -%}'
    bathroom_ago:
      entity_id: 
        - sensor.bathroom_date
        - sun.sun
      unit_of_measurement: seconds
      value_template: '{{ (now().timestamp()|int) - (states.sensor.bathroom_date.state|int) }}'
      icon_template: '{%- if (states.sensor.bathroom_ago.state|int) > 300 -%} mdi:timer-off {%- else -%} mdi:timer {%- endif -%}'
    frontdoor_ago:
      entity_id: 
        - sensor.frontdoor_date
        - sun.sun
      unit_of_measurement: seconds
      value_template: '{{ (now().timestamp()|int) - (states.sensor.frontdoor_date.state|int) }}'
      icon_template: '{%- if (states.sensor.frontdoor_ago.state|int) > 300 -%} mdi:timer-off {%- else -%} mdi:timer {%- endif -%}'
    road_ago:
      entity_id: 
        - sensor.road_date
        - sun.sun
      unit_of_measurement: seconds
      value_template: '{{ (now().timestamp()|int) - (states.sensor.road_date.state|int) }}'
      icon_template: '{%- if (states.sensor.road_ago.state|int) > 300 -%} mdi:timer-off {%- else -%} mdi:timer {%- endif -%}'
    interior_ago:
      entity_id:
        - sensor.kitchen_ago
        - sensor.bathroom_ago
        - sensor.frontdoor_ago
      unit_of_measurement: seconds
      value_template: >
        {{ ( states('sensor.kitchen_ago')|int, states('sensor.bathroom_ago')|int, states('sensor.frontdoor_ago')|int ) | list | min }}
    exterior_ago:
      entity_id: sensor.road_ago
      unit_of_measurement: seconds
      value_template: >
        {{ ( states('sensor.road_ago')|int,) | list | min }}
    kitchen_when:
      entity_id: sensor.kitchen_date
      value_template: '{{ (states.sensor.kitchen_date.state|int) | timestamp_custom("%a %b %d @ %I:%M %p") }}'
      icon_template: '{%- if ((states.sensor.kitchen_date.state|int) | timestamp_custom("%p")) == "PM" -%} mdi:weather-night {%- else -%} mdi:weather-sunny {%- endif -%}'
    bathroom_when:
      entity_id: sensor.bathroom_date
      value_template: '{{ (states.sensor.bathroom_date.state|int) | timestamp_custom("%a %b %d @ %I:%M %p") }}'
      icon_template: '{%- if ((states.sensor.bathroom_date.state|int) | timestamp_custom("%p")) == "PM" -%} mdi:weather-night {%- else -%} mdi:weather-sunny {%- endif -%}'
    frontdoor_when:
      entity_id: sensor.frontdoor_date
      value_template: '{{ (states.sensor.frontdoor_date.state|int) | timestamp_custom("%a %b %d @ %I:%M %p") }}'
      icon_template: '{%- if ((states.sensor.frontdoor_date.state|int) | timestamp_custom("%p")) == "PM" -%} mdi:weather-night {%- else -%} mdi:weather-sunny {%- endif -%}'
    road_when:
      entity_id: sensor.road_date
      value_template: '{{ (states.sensor.road_date.state|int) | timestamp_custom("%a %b %d @ %I:%M %p") }}'
      icon_template: '{%- if ((states.sensor.road_date.state|int) | timestamp_custom("%p")) == "PM" -%} mdi:weather-night {%- else -%} mdi:weather-sunny {%- endif -%}'

##
## FAMILY
##

binary_sensor family_home:
  platform: template
  sensors:
    family_kitchen:
      entity_id:
        - sensor.kitchen_what
      value_template: >
        {{ (states('binary_sensor.david_kitchen') and states('binary_sensor.david_home'))
           or (states('binary_sensor.keli_kitchen') and states('binary_sensor.keli_home'))
           or (states('binary_sensor.hali_kitchen') and states('binary_sensor.hali_home'))
           or (states('binary_sensor.ian_kitchen') and states('binary_sensor.ian_home'))
           or (states('binary_sensor.riley_kitchen') and states('binary_sensor.riley_home'))
           or (states('binary_sensor.ellen_kitchen') and states('binary_sensor.ellen_home'))
           and states('sensor.kitchen_ago')|int < 30 }}
    family_bathroom:
      entity_id:
        - sensor.bathroom_what
      value_template: >
        {{ (states('binary_sensor.david_bathroom') and states('binary_sensor.david_home'))
           or (states('binary_sensor.keli_bathroom') and states('binary_sensor.keli_home'))
           or (states('binary_sensor.hali_bathroom') and states('binary_sensor.hali_home'))
           or (states('binary_sensor.ian_bathroom') and states('binary_sensor.ian_home'))
           or (states('binary_sensor.riley_bathroom') and states('binary_sensor.riley_home'))
           or (states('binary_sensor.ellen_bathroom') and states('binary_sensor.ellen_home'))
           and states('sensor.bathroom_ago')|int < 30 }}
    family_frontdoor:
      entity_id:
        - sensor.frontdoor_what
      value_template: >
        {{ (states('binary_sensor.david_frontdoor') and states('binary_sensor.david_home'))
           or (states('binary_sensor.keli_frontdoor') and states('binary_sensor.keli_home'))
           or (states('binary_sensor.hali_frontdoor') and states('binary_sensor.hali_home'))
           or (states('binary_sensor.ian_frontdoor') and states('binary_sensor.ian_home'))
           or (states('binary_sensor.riley_frontdoor') and states('binary_sensor.riley_home'))
           or (states('binary_sensor.ellen_frontdoor') and states('binary_sensor.ellen_home'))
           and states('sensor.frontdoor_ago')|int < 30 }}

#
# ROAD
#

binary_sensor what_road:
  platform: template
  sensors:
    martin_road:
      entity_id:
        - sensor.road_what
      value_template: >
        {{ is_state('sensor.road_what','martin_c70') or
           is_state('sensor.road_what','martin_c30') or
           is_state('sensor.last_what','martin_xc90') or
           is_state('sensor.road_what','martin_sprinter') or
           is_state('sensor.road_what','martin_suburban') or
           is_state('sensor.road_what','martin_xc90') or
           is_state('sensor.road_what','martin_rtv1100' ) }}
    fletcher_road:
      entity_id:
        - sensor.road_what
      value_template: >
        {{ is_state('sensor.road_what','fletcher_fordflex') or
           is_state('sensor.road_what','fletcher_hybrid') or
           is_state('sensor.road_what','fletcher_pickup') }}
    other_road:
      entity_id:
        - sensor.road_what
      value_template: >
        {{ is_state('binary_sensor.martin_road','off') and is_state('binary_sensor.fletcher_road','off') }}

sensor other_road_count:
  - platform: history_stats
    name: other_road_count
    entity_id: binary_sensor.other_road
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor other_road_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: other_road_ratio
    entity_id: binary_sensor.other_road
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor other_road_time:
  - platform: history_stats
    icon: mdi:timer
    name: other_road_time
    entity_id: binary_sensor.other_road
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor martin_road_count:
  - platform: history_stats
    name: martin_road_count
    entity_id: binary_sensor.martin_road
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor martin_road_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: martin_road_ratio
    entity_id: binary_sensor.martin_road
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor martin_road_time:
  - platform: history_stats
    icon: mdi:timer
    name: martin_road_time
    entity_id: binary_sensor.martin_road
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor fletcher_road_count:
  - platform: history_stats
    name: fletcher_road_count
    entity_id: binary_sensor.fletcher_road
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor fletcher_road_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: fletcher_road_ratio
    entity_id: binary_sensor.fletcher_road
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor fletcher_road_time:
  - platform: history_stats
    icon: mdi:timer
    name: fletcher_road_time
    entity_id: binary_sensor.fletcher_road
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

##
## DAVID
##

binary_sensor david_motion:
  platform: template
  sensors:
    david_interior:
      entity_id: 
        - sensor.interior_what
      value_template: >
        {{ 'david' in states('sensor.interior_what') }}
    david_bathroom:
      entity_id: 
        - sensor.bathroom_what
      value_template: >
        {{ is_state('sensor.bathroom_what','david') }}
    david_frontdoor:
      entity_id: 
        - sensor.frontdoor_what
      value_template: >
        {{ is_state('sensor.frontdoor_what','david') }}
    david_kitchen:
      entity_id: 
        - sensor.kitchen_what
      value_template: >
        {{ is_state('sensor.kitchen_what','david') }}

sensor david_kitchen_time:
  - platform: history_stats
    icon: mdi:timer
    name: david_kitchen_time
    entity_id: binary_sensor.david_kitchen
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor david_bathroom_time:
  - platform: history_stats
    icon: mdi:timer
    name: david_bathroom_time
    entity_id: binary_sensor.david_bathroom
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor david_frontdoor_time:
  - platform: history_stats
    icon: mdi:timer
    name: david_frontdoor_time
    entity_id: binary_sensor.david_frontdoor
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor david_kitchen_count:
  - platform: history_stats
    name: david_kitchen_count
    entity_id: binary_sensor.david_kitchen
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor david_bathroom_count:
  - platform: history_stats
    name: david_bathroom_count
    entity_id: binary_sensor.david_bathroom
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor david_frontdoor_count:
  - platform: history_stats
    name: david_frontdoor_count
    entity_id: binary_sensor.david_frontdoor
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor david_kitchen_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: david_kitchen_ratio
    entity_id: binary_sensor.david_kitchen
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor david_bathroom_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: david_bathroom_ratio
    entity_id: binary_sensor.david_bathroom
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor david_frontdoor_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: david_frontdoor_ratio
    entity_id: binary_sensor.david_frontdoor
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

##
## KELI
##

binary_sensor keli_motion:
  platform: template
  sensors:
    keli_interior:
      entity_id: 
        - sensor.interior_what
      value_template: >
        {{ 'keli' in states('sensor.interior_what') }}
    keli_bathroom:
      entity_id: 
        - sensor.bathroom_what
      value_template: >
        {{ is_state('sensor.bathroom_what','keli') }}
    keli_frontdoor:
      entity_id: 
        - sensor.frontdoor_what
      value_template: >
        {{ is_state('sensor.frontdoor_what','keli') }}
    keli_kitchen:
      entity_id: 
        - sensor.kitchen_what
      value_template: >
        {{ is_state('sensor.kitchen_what','keli') }}

sensor keli_kitchen_time:
  - platform: history_stats
    icon: mdi:timer
    name: keli_kitchen_time
    entity_id: binary_sensor.keli_kitchen
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor keli_bathroom_time:
  - platform: history_stats
    icon: mdi:timer
    name: keli_bathroom_time
    entity_id: binary_sensor.keli_bathroom
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor keli_frontdoor_time:
  - platform: history_stats
    icon: mdi:timer
    name: keli_frontdoor_time
    entity_id: binary_sensor.keli_frontdoor
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor keli_kitchen_count:
  - platform: history_stats
    name: keli_kitchen_count
    entity_id: binary_sensor.keli_kitchen
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor keli_bathroom_count:
  - platform: history_stats
    name: keli_bathroom_count
    entity_id: binary_sensor.keli_bathroom
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor keli_frontdoor_count:
  - platform: history_stats
    name: keli_frontdoor_count
    entity_id: binary_sensor.keli_frontdoor
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor keli_kitchen_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: keli_kitchen_ratio
    entity_id: binary_sensor.keli_kitchen
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor keli_bathroom_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: keli_bathroom_ratio
    entity_id: binary_sensor.keli_bathroom
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor keli_frontdoor_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: keli_frontdoor_ratio
    entity_id: binary_sensor.keli_frontdoor
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

##
## HALI
##

binary_sensor hali_motion:
  platform: template
  sensors:
    hali_interior:
      entity_id: 
        - sensor.interior_what
      value_template: >
        {{ 'hali' in states('sensor.interior_what') }}
    hali_bathroom:
      entity_id: 
        - sensor.bathroom_what
      value_template: >
        {{ is_state('sensor.bathroom_what','hali') }}
    hali_frontdoor:
      entity_id: 
        - sensor.frontdoor_what
      value_template: >
        {{ is_state('sensor.frontdoor_what','hali') }}
    hali_kitchen:
      entity_id: 
        - sensor.kitchen_what
      value_template: >
        {{ is_state('sensor.kitchen_what','hali') }}

sensor hali_kitchen_time:
  - platform: history_stats
    icon: mdi:timer
    name: hali_kitchen_time
    entity_id: binary_sensor.hali_kitchen
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor hali_bathroom_time:
  - platform: history_stats
    icon: mdi:timer
    name: hali_bathroom_time
    entity_id: binary_sensor.hali_bathroom
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor hali_frontdoor_time:
  - platform: history_stats
    icon: mdi:timer
    name: hali_frontdoor_time
    entity_id: binary_sensor.hali_frontdoor
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor hali_kitchen_count:
  - platform: history_stats
    name: hali_kitchen_count
    entity_id: binary_sensor.hali_kitchen
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor hali_bathroom_count:
  - platform: history_stats
    name: hali_bathroom_count
    entity_id: binary_sensor.hali_bathroom
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor hali_frontdoor_count:
  - platform: history_stats
    name: hali_frontdoor_count
    entity_id: binary_sensor.hali_frontdoor
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor hali_kitchen_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: hali_kitchen_ratio
    entity_id: binary_sensor.hali_kitchen
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor hali_bathroom_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: hali_bathroom_ratio
    entity_id: binary_sensor.hali_bathroom
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor hali_frontdoor_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: hali_frontdoor_ratio
    entity_id: binary_sensor.hali_frontdoor
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

##
## IAN
##

binary_sensor ian_motion:
  platform: template
  sensors:
    ian_interior:
      entity_id: 
        - sensor.interior_what
      value_template: >
        {{ 'ian' in states('sensor.interior_what') }}
    ian_bathroom:
      entity_id: 
        - sensor.bathroom_what
      value_template: >
        {{ is_state('sensor.bathroom_what','ian') }}
    ian_frontdoor:
      entity_id: 
        - sensor.frontdoor_what
      value_template: >
        {{ is_state('sensor.frontdoor_what','ian') }}
    ian_kitchen:
      entity_id: 
        - sensor.kitchen_what
      value_template: >
        {{ is_state('sensor.kitchen_what','ian') }}

sensor ian_kitchen_time:
  - platform: history_stats
    icon: mdi:timer
    name: ian_kitchen_time
    entity_id: binary_sensor.ian_kitchen
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ian_bathroom_time:
  - platform: history_stats
    icon: mdi:timer
    name: ian_bathroom_time
    entity_id: binary_sensor.ian_bathroom
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ian_frontdoor_time:
  - platform: history_stats
    icon: mdi:timer
    name: ian_frontdoor_time
    entity_id: binary_sensor.ian_frontdoor
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ian_kitchen_count:
  - platform: history_stats
    name: ian_kitchen_count
    entity_id: binary_sensor.ian_kitchen
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ian_bathroom_count:
  - platform: history_stats
    name: ian_bathroom_count
    entity_id: binary_sensor.ian_bathroom
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ian_frontdoor_count:
  - platform: history_stats
    name: ian_frontdoor_count
    entity_id: binary_sensor.ian_frontdoor
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ian_kitchen_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: ian_kitchen_ratio
    entity_id: binary_sensor.ian_kitchen
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ian_bathroom_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: ian_bathroom_ratio
    entity_id: binary_sensor.ian_bathroom
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ian_frontdoor_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: ian_frontdoor_ratio
    entity_id: binary_sensor.ian_frontdoor
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

##
## RILEY
##

binary_sensor riley_motion:
  platform: template
  sensors:
    riley_interior:
      entity_id: 
        - sensor.interior_what
      value_template: >
        {{ 'riley' in states('sensor.interior_what') }}
    riley_bathroom:
      entity_id: 
        - sensor.bathroom_what
      value_template: >
        {{ is_state('sensor.bathroom_what','riley') }}
    riley_frontdoor:
      entity_id: 
        - sensor.frontdoor_what
      value_template: >
        {{ is_state('sensor.frontdoor_what','riley') }}
    riley_kitchen:
      entity_id: 
        - sensor.kitchen_what
      value_template: >
        {{ is_state('sensor.kitchen_what','riley') }}

sensor riley_kitchen_time:
  - platform: history_stats
    icon: mdi:timer
    name: riley_kitchen_time
    entity_id: binary_sensor.riley_kitchen
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor riley_bathroom_time:
  - platform: history_stats
    icon: mdi:timer
    name: riley_bathroom_time
    entity_id: binary_sensor.riley_bathroom
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor riley_frontdoor_time:
  - platform: history_stats
    icon: mdi:timer
    name: riley_frontdoor_time
    entity_id: binary_sensor.riley_frontdoor
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor riley_kitchen_count:
  - platform: history_stats
    name: riley_kitchen_count
    entity_id: binary_sensor.riley_kitchen
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor riley_bathroom_count:
  - platform: history_stats
    name: riley_bathroom_count
    entity_id: binary_sensor.riley_bathroom
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor riley_frontdoor_count:
  - platform: history_stats
    name: riley_frontdoor_count
    entity_id: binary_sensor.riley_frontdoor
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor riley_kitchen_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: riley_kitchen_ratio
    entity_id: binary_sensor.riley_kitchen
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor riley_bathroom_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: riley_bathroom_ratio
    entity_id: binary_sensor.riley_bathroom
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor riley_frontdoor_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: riley_frontdoor_ratio
    entity_id: binary_sensor.riley_frontdoor
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

##
## ELLEN
##

binary_sensor ellen_motion:
  platform: template
  sensors:
    ellen_interior:
      entity_id: 
        - sensor.interior_what
      value_template: >
        {{ 'ellen' in states('sensor.interior_what') }}
    ellen_bathroom:
      entity_id: 
        - sensor.bathroom_what
      value_template: >
        {{ is_state('sensor.bathroom_what','ellen') }}
    ellen_frontdoor:
      entity_id: 
        - sensor.frontdoor_what
      value_template: >
        {{ is_state('sensor.frontdoor_what','ellen') }}
    ellen_kitchen:
      entity_id: 
        - sensor.kitchen_what
      value_template: >
        {{ is_state('sensor.kitchen_what','ellen') }}

sensor ellen_kitchen_time:
  - platform: history_stats
    icon: mdi:timer
    name: ellen_kitchen_time
    entity_id: binary_sensor.ellen_kitchen
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ellen_bathroom_time:
  - platform: history_stats
    icon: mdi:timer
    name: ellen_bathroom_time
    entity_id: binary_sensor.ellen_bathroom
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ellen_frontdoor_time:
  - platform: history_stats
    icon: mdi:timer
    name: ellen_frontdoor_time
    entity_id: binary_sensor.ellen_frontdoor
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ellen_kitchen_count:
  - platform: history_stats
    name: ellen_kitchen_count
    entity_id: binary_sensor.ellen_kitchen
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ellen_bathroom_count:
  - platform: history_stats
    name: ellen_bathroom_count
    entity_id: binary_sensor.ellen_bathroom
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ellen_frontdoor_count:
  - platform: history_stats
    name: ellen_frontdoor_count
    entity_id: binary_sensor.ellen_frontdoor
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ellen_kitchen_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: ellen_kitchen_ratio
    entity_id: binary_sensor.ellen_kitchen
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ellen_bathroom_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: ellen_bathroom_ratio
    entity_id: binary_sensor.ellen_bathroom
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor ellen_frontdoor_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: ellen_frontdoor_ratio
    entity_id: binary_sensor.ellen_frontdoor
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

##
## CORRECT RATIO
##

sensor kitchen_accuracy_ratio:
  - platform: history_stats
    icon: mdi:bullseye
    name: kitchen_accuracy_ratio
    entity_id: binary_sensor.kitchen_wrong
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor bathroom_accuracy_ratio:
  - platform: history_stats
    icon: mdi:bullseye
    name: bathroom_accuracy_ratio
    entity_id: binary_sensor.bathroom_wrong
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor frontdoor_accuracy_ratio:
  - platform: history_stats
    icon: mdi:bullseye
    name: frontdoor_accuracy_ratio
    entity_id: binary_sensor.frontdoor_wrong
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor road_accuracy_ratio:
  - platform: history_stats
    icon: mdi:bullseye
    name: road_accuracy_ratio
    entity_id: binary_sensor.road_wrong
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

##
## LAST DETECTION
##

sensor interior_entity:
  platform: template
  sensors:
    interior_last:
      entity_id:
        - sensor.bathroom_last
        - sensor.kitchen_last
        - sensor.frontdoor_last
      value_template: >
        {{ states('sensor.bathroom_last'),states('sensor.kitchen_last'),states('sensor.frontdoor_last') }}
    interior_what:
      entity_id:
        - sensor.bathroom_what
        - sensor.kitchen_what
        - sensor.frontdoor_what
      value_template: >
        {{ states('sensor.bathroom_what'),states('sensor.kitchen_what'),states('sensor.frontdoor_what') }}


##
## MOTION (YES/NO, LOCATIONs count, LOCATIONs time,
##

binary_sensor location_motion:
  platform: template
  sensors:
    kitchen_motion:
      entity_id: 
        - sensor.kitchen_ago
      device_class: motion
      value_template: >
        {{  states('sensor.kitchen_ago')|int < 30 }}
    bathroom_motion:
      entity_id:
        - sensor.bathroom_ago
      device_class: motion
      value_template: >
        {{  states('sensor.bathroom_ago')|int < 30 }}
    frontdoor_motion:
      entity_id: 
        - sensor.frontdoor_ago
      device_class: motion
      value_template: >
        {{  states('sensor.frontdoor_ago')|int < 30 }}
    interior_motion:
      device_class: motion
      entity_id:
        - binary_sensor.kitchen_motion
        - binary_sensor.bathroom_motion
        - binary_sensor.frontdoor_motion
      value_template: >
        {{ is_state('binary_sensor.kitchen_motion','on') or is_state('binary_sensor.bathroom_motion','on') or is_state('binary_sensor.frontdoor_motion','on') }}
    road_motion:
      entity_id: 
        - sensor.road_ago
      device_class: motion
      value_template: >
        {{  states('sensor.road_ago')|int < 30 }}
    exterior_motion:
      device_class: motion
      entity_id: 
        - binary_sensor.road_motion
      value_template: >
        {{ is_state('binary_sensor.road_motion','on') }}

# RATIO

sensor interior_motion_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: interior_motion_ratio
    entity_id: binary_sensor.interior_motion
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor exterior_motion_ratio:
  - platform: history_stats
    icon: mdi:timer
    name: exterior_motion_ratio
    entity_id: binary_sensor.exterior_motion
    state: 'on'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

# COUNT

sensor kitchen_motion_count:
  - platform: history_stats
    name: kitchen_motion_count
    entity_id: binary_sensor.kitchen_motion
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor bathroom_motion_count:
  - platform: history_stats
    name: bathroom_motion_count
    entity_id: binary_sensor.bathroom_motion
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor frontdoor_motion_count:
  - platform: history_stats
    name: frontdoor_motion_count
    entity_id: binary_sensor.frontdoor_motion
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor road_motion_count:
  - platform: history_stats
    name: road_motion_count
    entity_id: binary_sensor.road_motion
    state: 'on'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

# TIME

sensor kitchen_motion_time:
  - platform: history_stats
    icon: mdi:timer
    name: kitchen_motion_time
    entity_id: binary_sensor.kitchen_motion
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor bathroom_motion_time:
  - platform: history_stats
    icon: mdi:timer
    name: bathroom_motion_time
    entity_id: binary_sensor.bathroom_motion
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor frontdoor_motion_time:
  - platform: history_stats
    icon: mdi:timer
    name: frontdoor_motion_time
    entity_id: binary_sensor.frontdoor_motion
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

sensor road_motion_time:
  - platform: history_stats
    icon: mdi:timer
    name: road_motion_time
    entity_id: binary_sensor.road_motion
    state: 'on'
    type: time
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

#
# DETERMINISTIC
#

binary_sensor probably_home:
  platform: template
  sensors:
    david_home:
      entity_id: 
        - device_tracker.dcmsiphone7
        - device_tracker.davids_iphone
      value_template: >
        {{ is_state('device_tracker.dcmsiphone7','home') or is_state('device_tracker.davids_iphone','home') }}
    keli_home:
      entity_id: 
        - device_tracker.kelisiphone7
        - device_tracker.kelis_iphone
      value_template: >
        {{ is_state('device_tracker.kelisiphone7','home') or is_state('device_tracker.kelis_iphone','home') }}
    hali_home:
      entity_id: 
        - device_tracker.halisiphone
      value_template: >
        {{ is_state('device_tracker.halisiphone','home') }}
    ian_home:
      entity_id: 
        - device_tracker.ianmartinsiphone
      value_template: >
        {{ is_state('device_tracker.ianmartinsiphone','home') }}
    riley_home:
      entity_id: 
        - device_tracker.rileysiphone5
        - device_tracker.rileys_iphone
      value_template: >
        {{ is_state('device_tracker.rileysiphone5','home') or is_state('device_tracker.rileys_iphone','home') }}
    ellen_home:
      entity_id: 
        - device_tracker.ellensiphone5
        - device_tracker.ellens_iphone
      value_template: >
        {{ is_state('device_tracker.ellensiphone5','home') or is_state('device_tracker.ellens_iphone','home') }}

#
# BAYESIAN
#

binary_sensor david_maybe_home:
  - platform: bayesian
    name: david_maybe_home
    prior: 0.75
    observations:
      - entity_id: device_tracker.davids_iphone
        prob_given_true: 0.9
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: device_tracker.dcmsiphone7
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'

binary_sensor keli_maybe_home:
  - platform: bayesian
    name: keli_maybe_home
    prior: 0.75
    observations:
      - entity_id: device_tracker.kelis_iphone
        prob_given_true: 0.9
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: device_tracker.kelisiphone7
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'

binary_sensor riley_maybe_home:
  - platform: bayesian
    name: riley_maybe_home
    prior: 0.75
    observations:
      - entity_id: device_tracker.rileys_iphone
        prob_given_true: 0.9
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: device_tracker.rileysiphone5
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'

binary_sensor ellen_maybe_home:
  - platform: bayesian
    name: ellen_maybe_home
    prior: 0.75
    observations:
      - entity_id: device_tracker.ellens_iphone
        prob_given_true: 0.9
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'
      - entity_id: device_tracker.ellensiphone5
        prob_given_true: 0.8
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'home'

binary_sensor hali_maybe_home:
  - platform: bayesian
    name: hali_maybe_home
    prior: 0.2
    observations:
      - entity_id: device_tracker.halisiphone
        prob_given_true: 0.9
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'

binary_sensor ian_maybe_home:
  - platform: bayesian
    name: ian_maybe_home
    prior: 0.1
    observations:
      - entity_id: device_tracker.ianmartinsiphone
        prob_given_true: 0.9
        prob_given_false: 0.1
        platform: 'state'
        to_state: 'home'

###
### TRACK PEOPLE
###

sensor people_location_template:
  platform: template
  sensors:
    david_status:
      friendly_name: "David's status"
      entity_id:
        - group.david_devices
      value_template: >
       {%- set e = closest(states.group.david_devices) -%}
       {%- if e is defined -%} 
         {%- set d = distance(e) -%}
         {%- if e.source_type == 'gps' -%} 
           {"device":{{ e.attributes.friendly_name|tojson }},"location":{{e.state|tojson}},"online":{{(e.attributes.device_status == 'online')|tojson}},"feet":{{d*5280.0}}}
         {%- else -%}
           {"device":{{ e.attributes.friendly_name|tojson }},"location":"home","online":true,"feet":{{d*5280.0}}}
         {%- endif -%}
       {%- endif -%}
    david_location:
      friendly_name: "David's location"
      entity_id:
        - group.david_devices
      value_template: >
        {{ closest(states.group.david_devices).state }}
    keli_location:
      entity_id: device_tracker.kelisiphone7
      friendly_name: "Keli's location"
      value_template: >
        {{ states('device_tracker.kelisiphone7') }}
    hali_location:
      entity_id: 
        - group.hali_devices
      friendly_name: "Hali's location"
      value_template: >
        {{ closest(states.group.hali_devices).state }}
    ian_location:
      entity_id: device_tracker.ianmartinsiphone 
      friendly_name: "Ian's location"
      value_template: >
        {{ states('device_tracker.ianmartinsiphone') }}
    riley_location:
      entity_id: device_tracker.rileysiphone5
      friendly_name: "Riley's location"
      value_template: >
        {{ states('device_tracker.rileysiphone5') }}
    ellen_location:
      entity_id: device_tracker.ellensiphone5
      friendly_name: "Ellen's location"
      value_template: >
        {{ states('device_tracker.ellensiphone5') }}

logger: !include logger.yaml
group: !include groups.yaml

###
### CONFIGURATION AND DISCOVERY
###

sensor aah_device_count:
  - platform: rest
    resource: 'http://192.168.1.32/CGI/aah-devices.cgi'
    name: aah_device_count
    value_template: >
      {%- if value_json is defined -%}
        {%- if value_json.devices is defined -%}
          {%- if value_json.devices != [] -%}
            {{ value_json.devices|length | default(0) }}
          {%- else -%} 0 {%- endif -%}
        {%- else -%} -1 {%- endif -%}
      {%- else -%} -2 {%- endif -%}

sensor aah_device_names:
  - platform: rest
    resource: 'http://192.168.1.32/CGI/aah-devices.cgi'
    name: aah_device_names
    value_template: >
      {%- if value_json is defined -%}
        {%- if value_json.devices is defined -%}
          {%- if value_json.devices != [] -%}
          {%- for device in value_json.devices -%}
            {%- if loop.first -%} {%- else -%}, {%- endif -%} 
            {{ device.name | default(null) }}
          {%- endfor -%}
          {%- else -%} 'no device' {%- endif -%}
        {%- else -%} 'undefined' {%- endif -%}
      {%- else -%} 'no service' {%- endif -%}

sensor aah_device_dates:
  - platform: rest
    resource: 'http://192.168.1.32/CGI/aah-devices.cgi'
    name: aah_device_dates
    value_template: >
      {%- if value_json is defined -%}
        {%- if value_json.devices is defined -%}
          {%- if value_json.devices != [] -%}
          {%- for device in value_json.devices -%}
            {%- if loop.first -%} {%- else -%}, {%- endif -%} 
            {{ (device.date|int) | default(null) }}
          {%- endfor -%}
          {%- else -%} 'no device' {%- endif -%}
        {%- else -%} 'undefined' {%- endif -%}
      {%- else -%} 'no service' {%- endif -%}

binary_sensor device_template:
  platform: template
  sensors:
    online_kitchen:
      entity_id:
        - device_tracker.ageathome_kitchen_camera
      value_template: >
        {{ states.device_tracker.ageathome_kitchen_camera != None and
           states.device_tracker.ageathome_kitchen_camera.state != None and
           states.device_tracker.ageathome_kitchen_camera.state == 'home' }}
    online_bathroom:
      entity_id:
        - device_tracker.ageathome_bathroom_camera
      value_template: >
        {{ states.device_tracker.ageathome_bathroom_camera != None and
           states.device_tracker.ageathome_bathroom_camera.state != None and
           states.device_tracker.ageathome_bathroom_camera.state == 'home' }}
    online_frontdoor:
      entity_id:
        - device_tracker.ageathome_frontdoor_camera
      value_template: >
        {{ states.device_tracker.ageathome_frontdoor_camera != None and
           states.device_tracker.ageathome_frontdoor_camera.state != None and
           states.device_tracker.ageathome_frontdoor_camera.state == 'home' }}
    online_road:
      entity_id:
        - device_tracker.ageathome_road_camera
      value_template: >
        {{ states.device_tracker.ageathome_road_camera != None and
           states.device_tracker.ageathome_road_camera.state != None and
           states.device_tracker.ageathome_road_camera.state == 'home' }}

## determine if aah_discovery & aah_config are defined (url, ..)
binary_sensor template:
  - platform: template
    sensors:
      aah_discovery_complete:
        entity_id: 
          - sensor.aah_discovery
        value_template: >
          {{ states.binary_sensor.aah_discovery != None and
             states.binary_sensor.aah_discovery.state != 'unknown' and
             states.binary_sensor.aah_discovery.attributes != None and
             states.binary_sensor.aah_discovery.attributes.url != None and
             states.binary_sensor.aah_discovery.attributes.url != 'null' }}
      aah_config_complete:
        entity_id: 
          - sensor.aah_config
        value_template: >
          {{ states.binary_sensor.aah_config != None and
             states.binary_sensor.aah_config.state != 'unknown' and
             states.binary_sensor.aah_config.attributes != None and
             states.binary_sensor.aah_config.attributes.vr_apikey != None and
             states.binary_sensor.aah_config.attributes.vr_apikey != 'null' }}

## HISTORY GRAPH
history_graph:
  kitchen_accuracy:
    name: Kitchen Accuracy
    entities:
      - sensor.kitchen_accuracy_ratio
    hours_to_show: 24
    refresh: 60
  kitchen_time:
    name: Kitchen Time
    entities:
      - sensor.david_kitchen_time
      - sensor.keli_kitchen_time
      - sensor.hali_kitchen_time
      - sensor.ian_kitchen_time
      - sensor.riley_kitchen_time
      - sensor.ellen_kitchen_time
    hours_to_show: 24
    refresh: 60
  kitchen_ratio:
    name: Kitchen Ratio
    entities:
      - sensor.david_kitchen_ratio
      - sensor.keli_kitchen_ratio
      - sensor.hali_kitchen_ratio
      - sensor.ian_kitchen_ratio
      - sensor.riley_kitchen_ratio
      - sensor.ellen_kitchen_ratio
    hours_to_show: 24
    refresh: 60
  kitchen_count:
    name: Kitchen Count
    entities:
      - sensor.david_kitchen_count
      - sensor.keli_kitchen_count
      - sensor.hali_kitchen_count
      - sensor.ian_kitchen_count
      - sensor.riley_kitchen_count
      - sensor.ellen_kitchen_count
      - sensor.kitchen_motion_count
    hours_to_show: 24
    refresh: 60
  bathroom_accuracy:
    name: Bathroom Accuracy
    entities:
      - sensor.bathroom_accuracy_ratio
    hours_to_show: 24
    refresh: 60
  bathroom_time:
    name: Bathroom Time
    entities:
      - sensor.david_bathroom_time
      - sensor.keli_bathroom_time
      - sensor.hali_bathroom_time
      - sensor.ian_bathroom_time
      - sensor.riley_bathroom_time
      - sensor.ellen_bathroom_time
    hours_to_show: 24
    refresh: 60
  bathroom_ratio:
    name: Bathroom Ratio
    entities:
      - sensor.david_bathroom_ratio
      - sensor.keli_bathroom_ratio
      - sensor.hali_bathroom_ratio
      - sensor.ian_bathroom_ratio
      - sensor.riley_bathroom_ratio
      - sensor.ellen_bathroom_ratio
    hours_to_show: 24
    refresh: 60
  bathroom_count:
    name: Bathroom Count
    entities:
      - sensor.david_bathroom_count
      - sensor.keli_bathroom_count
      - sensor.hali_bathroom_count
      - sensor.ian_bathroom_count
      - sensor.riley_bathroom_count
      - sensor.ellen_bathroom_count
      - sensor.bathroom_motion_count
    hours_to_show: 24
    refresh: 60
  frontdoor_accuracy:
    name: Frontdoor Accuracy
    entities:
      - sensor.frontdoor_accuracy_ratio
    hours_to_show: 24
    refresh: 60
  frontdoor_time:
    name: Frontdoor Time
    entities:
      - sensor.david_frontdoor_time
      - sensor.keli_frontdoor_time
      - sensor.hali_frontdoor_time
      - sensor.ian_frontdoor_time
      - sensor.riley_frontdoor_time
      - sensor.ellen_frontdoor_time
    hours_to_show: 24
    refresh: 60
  frontdoor_ratio:
    name: Frontdoor Ratio
    entities:
      - sensor.david_frontdoor_ratio
      - sensor.keli_frontdoor_ratio
      - sensor.hali_frontdoor_ratio
      - sensor.ian_frontdoor_ratio
      - sensor.riley_frontdoor_ratio
      - sensor.ellen_frontdoor_ratio
    hours_to_show: 24
    refresh: 60
  frontdoor_count:
    name: Frontdoor Count
    entities:
      - sensor.david_frontdoor_count
      - sensor.keli_frontdoor_count
      - sensor.hali_frontdoor_count
      - sensor.ian_frontdoor_count
      - sensor.riley_frontdoor_count
      - sensor.ellen_frontdoor_count
      - sensor.frontdoor_motion_count
    hours_to_show: 24
    refresh: 60
  road_accuracy:
    name: Road Accuracy
    entities:
      - sensor.road_accuracy_ratio
    hours_to_show: 24
    refresh: 60
  road_time:
    name: Road Time
    entities:
      - sensor.martin_road_time
      - sensor.fletcher_road_time
      - sensor.other_road_time
    hours_to_show: 24
    refresh: 60
  road_ratio:
    name: Road Ratio
    entities:
      - sensor.martin_road_ratio
      - sensor.fletcher_road_ratio
      - sensor.other_road_ratio
    hours_to_show: 24
    refresh: 60
  road_count:
    name: Road Count
    entities:
      - sensor.martin_road_count
      - sensor.fletcher_road_count
      - sensor.other_road_count
    hours_to_show: 24
    refresh: 60

##
## INPUT
##

input_text:
  test1:
    name: test1
    initial: type something here

###
### IOS
###

ios:
  push:
    categories:
      - name: Alarm
        identifier: 'ALARM'
        actions:
          - identifier: 'SOUND_ALARM'
            title: 'Sound Alarm'
            activationMode: 'background'
            authenticationRequired: no
            destructive: yes
            behavior: 'default'
          - identifier: 'SILENCE_ALARM'
            title: 'Silence Alarm'
            activationMode: 'foreground'
            authenticationRequired: yes
            destructive: no
            behavior: 'textInput'
            textInputButtonTitle: 'Silencio!'
            textInputPlaceholder: 'Placeholder'

##
## SCRIPTS
##

# nothing (yet)
script: !include scripts.yaml

##
## AUTOMATIONS
##

automation: !include automations.yaml
